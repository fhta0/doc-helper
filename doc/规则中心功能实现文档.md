# 规则中心与智能规则定义功能实现文档

## 1. 功能概述

### 1.1 功能目标
提供灵活的文档格式规则管理功能，用户可以查看、选择、创建自定义格式规则模板，支持AI智能解析和文档逆向工程两种方式创建规则。

### 1.2 核心特性
- **规则模板管理**：系统内置常用格式规范（GB/T 7714-2015、本科/硕博论文、期刊投稿等）
- **自定义模板**：用户可创建和编辑个人格式规范
- **AI智能解析**：输入自然语言格式要求，AI自动解析为结构化规则配置
- **文档逆向工程**：上传符合格式的范文文档，自动提取格式规则
- **实时预览**：修改参数时实时预览A4纸张效果
- **规则集成**：检测时可选择规则模板进行比对

### 1.3 业务流程

```
用户访问规则中心
    ↓
选择系统模板或自定义模板
    ↓
[路径A] 直接使用模板进行检测
    ↓
返回控制台，选择模板并上传文档

[路径B] 创建新规则
    ↓
选择输入方式：
  - 文字描述：输入格式要求文字 → AI解析
  - 上传范文：上传.docx文档 → 逆向提取
    ↓
查看解析结果和预览效果
    ↓
保存为自定义模板
```

---

## 2. 技术架构

### 2.1 技术选型

| 技术点 | 方案 | 说明 |
|--------|------|------|
| 规则存储 | JSON字段 | 灵活存储页边距、字体、行距等配置 |
| AI解析 | OpenAI兼容API | 使用LLM将自然语言转为结构化配置 |
| 文档解析 | python-docx | 提取文档样式信息 |
| 规则转换 | config_to_rules() | 将模板配置转换为检测规则 |
| 实时预览 | Vue响应式绑定 | 修改参数即时更新预览样式 |

### 2.2 文件结构

```
frontend/src/
├── views/
│   ├── RulesView.vue          # 规则中心页面（三栏布局）
│   └── NewRuleView.vue        # 新建规则页面（AI解析）
├── api/
│   └── index.js               # ruleTemplateApi接口
└── router/
    └── index.js               # 路由配置

backend/app/
├── models/
│   └── rule_template.py       # RuleTemplate模型
├── api/
│   └── rule_templates.py      # 规则模板API路由
├── services/
│   ├── ai_rule_parser.py      # AI规则解析服务
│   ├── docx_parser.py         # Docx文档解析
│   └── rule_engine.py         # 规则引擎（含config_to_rules）
└── utils/
    └── __init__.py            # DocxParser辅助函数
```

---

## 3. 数据库设计

### 3.1 规则模板表 (rule_templates)

```python
class RuleTemplate(Base):
    __tablename__ = "rule_templates"

    id = Column(Integer, primary_key=True)
    name = Column(String(100), nullable=False)           # 模板名称
    description = Column(Text)                           # 模板描述
    template_type = Column(String(20))                   # 类型: system/custom
    user_id = Column(Integer, ForeignKey("users.id"))   # 所属用户（系统模板为NULL）
    config_json = Column(JSON, nullable=False)          # 规则配置（JSON格式）
    is_default = Column(Boolean, default=False)          # 是否为默认模板
    use_count = Column(Integer, default=0)               # 使用次数
    created_at = Column(DateTime, server_default=func.now())
    updated_at = Column(DateTime, onupdate=func.now())
```

### 3.2 配置JSON结构

```json
{
  "page": {
    "margins": {
      "top_cm": 2.5,
      "bottom_cm": 2.5,
      "left_cm": 3.0,
      "right_cm": 2.5
    },
    "paper_name": "A4"
  },
  "headings": [
    {
      "level": 1,
      "font": "SimHei",
      "size_pt": 16,
      "bold": true,
      "alignment": "center"
    },
    {
      "level": 2,
      "font": "SimHei",
      "size_pt": 14,
      "bold": true,
      "alignment": "left"
    }
  ],
  "body": {
    "font": "SimSun",
    "size_pt": 12,
    "line_spacing_pt": 25,
    "first_line_indent_chars": 2
  }
}
```

### 3.3 Check表新增字段

```python
# 关联到检测记录
rule_template_id = Column(Integer, ForeignKey("rule_templates.id"))  # 使用的模板ID
rule_config_json = Column(JSON)                                      # 规则配置快照
```

---

## 4. API接口设计

### 4.1 获取模板列表

**接口**: `GET /api/rule-templates`

**参数**:
- `template_type` (可选): "system" 或 "custom"

**响应**:
```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "templates": [
      {
        "id": 1,
        "name": "GB/T 7714-2015 学术论文",
        "description": "中国国家标准学术论文格式规范",
        "template_type": "system",
        "is_default": true,
        "use_count": 100,
        "config": {...}
      }
    ]
  }
}
```

### 4.2 创建模板

**接口**: `POST /api/rule-templates`

**请求**:
```json
{
  "name": "我的论文格式",
  "description": "自定义格式要求",
  "config": {
    "page": {...},
    "headings": [...],
    "body": {...}
  }
}
```

### 4.3 AI文本解析

**接口**: `POST /api/rule-templates/parse/text`

**参数**: `text` (query string)

**请求示例**: `/api/rule-templates/parse/text?text=正文仿宋四号，行距25磅`

**响应**:
```json
{
  "code": 200,
  "data": {
    "config": {
      "body": {
        "font": "FangSong",
        "size_pt": 14,
        "line_spacing_pt": 25
      }
    }
  }
}
```

### 4.4 Docx文档解析

**接口**: `POST /api/rule-templates/parse/docx`

**请求**: multipart/form-data
- `file`: .docx文件

**响应**:
```json
{
  "code": 200,
  "data": {
    "filename": "范文.docx",
    "config": {...}
  }
}
```

---

## 5. 前端实现

### 5.1 规则中心页面 (RulesView.vue)

#### 三栏布局
```
┌─────────┬─────────────────────┬─────────────┐
│ 模板列表 │    文档预览         │  参数设置    │
│  (17%)  │      (58%)         │   (25%)     │
│         │                     │             │
│- 系统   │  ┌───────────────┐  │ 页边距      │
│- 自定义 │  │               │  │ 标题样式    │
│+ 新建   │  │  A4 预览区域   │  │ 正文样式    │
│         │  │               │  │             │
│         │  │               │  │ [保存修改]  │
│         │  └───────────────┘  │ [保存副本]  │
└─────────┴─────────────────────┴─────────────┘
```

#### 核心逻辑

```javascript
// 选择模板
const selectTemplate = (template) => {
  currentTemplate.value = template
  localConfig.value = JSON.parse(JSON.stringify(template.config))
  isReadonly.value = template.template_type === 'system'
}

// 实时预览样式
const configMargins = computed(() => {
  const m = localConfig.value.page.margins
  return `${m.top_cm * 37.8}px ${m.right_cm * 37.8}px ...`
})

const getHeadingStyle = (level) => {
  const heading = localConfig.value.headings.find(h => h.level === level)
  return {
    fontFamily: heading.font,
    fontSize: heading.size_pt + 'pt',
    fontWeight: heading.bold ? 'bold' : 'normal',
    textAlign: heading.alignment
  }
}
```

### 5.2 新建规则页面 (NewRuleView.vue)

#### 三栏布局

```
┌──────────────┬──────────────────┬──────────────┐
│   输入区域   │   AI解析流      │  规则预览    │
│             │                 │             │
│ [上传范文]  │   等待输入...   │  ┌────────┐ │
│             │                 │  │        │ │
│ 或输入格式:  │   AI解析中...   │  │  A4    │ │
│ ┌─────────┐ │                 │  │  预览  │ │
│ │正文仿宋 │ │   ✅ 解析成功!  │  │        │ │
│ │四号...  │ │                 │  └────────┘ │
│ └─────────┘ │   提取配置:     │             │
│             │   • 页边距      │ [保存模板]  │
│ [开始AI解析]│   • 正文字体    │             │
│             │   • 标题样式    │             │
└──────────────┴──────────────────┴──────────────┘
```

#### 核心逻辑

```javascript
// AI解析
const startAIAnalysis = async () => {
  if (uploadedFile.value) {
    // Docx解析
    const res = await ruleTemplateApi.parseDocx(uploadedFile.value)
    analysisResult.value = res.data.data.config
  } else {
    // 文本解析
    const res = await ruleTemplateApi.parseText(formatText.value)
    analysisResult.value = res.data.data.config
  }
}

// 保存模板
const saveTemplate = async () => {
  await ruleTemplateApi.createTemplate(
    templateName.value,
    '通过AI解析创建的格式模板',
    analysisResult.value
  )
  router.push('/rules')
}
```

### 5.3 Dashboard集成

```vue
<!-- 模板选择器 -->
<select v-model="selectedTemplateId">
  <option value="">选择格式规范模板...</option>
  <optgroup label="系统模板">
    <option v-for="t in systemTemplates" :value="t.id">
      {{ t.name }}
    </option>
  </optgroup>
  <optgroup label="自定义模板">
    <option v-for="t in customTemplates" :value="t.id">
      {{ t.name }}
    </option>
  </optgroup>
</select>

<!-- 提交检测时传递模板ID -->
await checkApi.submit(fileId, checkType, filename, selectedTemplateId)
```

---

## 6. 后端实现

### 6.1 AI规则解析器 (ai_rule_parser.py)

#### System Prompt设计

```python
SYSTEM_PROMPT = """你是一个专业的文档格式规范解析专家。
请将用户的格式要求解析为JSON格式：

{
  "page": {
    "margins": {"top_cm": 2.5, "bottom_cm": 2.5, ...},
    "paper_name": "A4"
  },
  "headings": [
    {"level": 1, "font": "SimHei", "size_pt": 16, ...}
  ],
  "body": {
    "font": "SimSun",
    "size_pt": 12,
    "line_spacing_pt": 25,
    "first_line_indent_chars": 2
  }
}

常见转换参考：
- 字号：四号=14pt, 小四=12pt, 三号=16pt
- 行距：1.5倍=25pt, 20磅=20pt
- 字体：宋体=SimSun, 黑体=SimHei, 楷体=KaiTi, 仿宋=FangSong
"""
```

#### 规则解析后备方案

```python
def _rule_based_parse(self, text: str) -> Dict[str, Any]:
    """使用正则表达式解析格式要求"""
    config = self._get_default_config()

    # 提取页边距
    top_match = re.search(r"上(?:页边距)?[：:]\\s*(\\d+\\.?\\d*)\\s*cm", text)
    if top_match:
        config["page"]["margins"]["top_cm"] = float(top_match.group(1))

    # 提取正文字体
    body_font_match = re.search(r"正文[：:]\\s*([^\\s，。；,]+?)\\s*(\\d+\\.?\\d*)\\s*([号pt磅]|[四三二一小初]+)", text)
    # ...

    return config
```

### 6.2 Docx逆向工程 (rule_templates.py)

```python
@router.post("/parse/docx")
async def parse_docx_for_config(
    file: UploadFile = File(...),
    current_user: User = Depends(get_current_user_optional),
    db: Session = Depends(get_db)
):
    """从docx文档逆向提取格式配置"""

    # 解析文档
    parse_result = parse_document_safe(file.file)
    doc_data = parse_result["data"]

    # 提取配置
    config = _extract_config_from_doc_data(doc_data)

    return ApiResponse(data={"filename": file.filename, "config": config})

def _extract_config_from_doc_data(doc_data: Dict) -> Dict:
    """从文档数据提取格式配置"""
    config = _get_default_config()

    # 提取页边距
    page_settings = doc_data.get("page_settings", {})
    if page_settings.get("margins"):
        m = page_settings["margins"]
        config["page"]["margins"] = {
            "top_cm": round(m.get("top_mm", 25) / 10, 1),
            "bottom_cm": round(m.get("bottom_mm", 25) / 10, 1),
            "left_cm": round(m.get("left_mm", 30) / 10, 1),
            "right_cm": round(m.get("right_mm", 25) / 10, 1)
        }

    # 提取标题样式
    headings = doc_data.get("headings", [])
    # 按level分组，取最常见的样式作为代表
    for level in range(1, 4):
        level_headings = [h for h in headings if h.get("level") == level]
        if level_headings:
            # 取第一个作为代表
            h = level_headings[0]
            config["headings"].append({
                "level": level,
                "font": h.get("font", {}).get("name", "SimHei"),
                "size_pt": int(h.get("font", {}).get("size_pt", 14)),
                "bold": h.get("font", {}).get("bold", True),
                "alignment": h.get("alignment", "left")
            })

    # 提取正文样式
    paragraphs = doc_data.get("paragraphs", [])
    if paragraphs:
        first_para = paragraphs[0]
        config["body"] = {
            "font": first_para.get("font", {}).get("name", "SimSun"),
            "size_pt": int(first_para.get("font", {}).get("size_pt", 12)),
            "line_spacing_pt": int(first_para.get("formatting", {}).get("line_spacing", 25)),
            "first_line_indent_chars": int(first_para.get("formatting", {}).get("first_line_indent_chars", 2))
        }

    return config
```

### 6.3 配置转规则 (rule_engine.py)

```python
def config_to_rules(config: Dict[str, Any]) -> List[Dict[str, Any]]:
    """将模板配置转换为规则引擎规则"""
    rules = []

    # 页边距规则
    margins = config.get("page", {}).get("margins", {})
    rules.append({
        "id": 1001,
        "name": "页边距检查",
        "category": "page",
        "match": "document",
        "condition": {
            "top_mm": margins.get("top_cm", 2.5) * 10,
            "bottom_mm": margins.get("bottom_cm", 2.5) * 10,
            "left_mm": margins.get("left_cm", 3.0) * 10,
            "right_mm": margins.get("right_cm", 2.5) * 10,
            "tolerance_mm": 2
        },
        "error_message": f"页边距不符合规范",
        "suggestion": f"请设置页边距为：上下{margins.get('top_cm')}cm，左右{margins.get('left_cm')}cm"
    })

    # 正文字体规则
    body = config.get("body", {})
    rules.append({
        "id": 1002,
        "name": "正文字体字号检查",
        "category": "font",
        "match": "run",
        "condition": {
            "chinese_font": body.get("font", "SimSun"),
            "chinese_size_pt": body.get("size_pt", 12)
        },
        "error_message": f"正文应使用{body.get('font')} {body.get('size_pt')}pt字体"
    })

    # 标题样式规则
    for heading in config.get("headings", []):
        rules.append({
            "id": 1000 + heading["level"],
            "name": f"{heading['level']}级标题样式检查",
            "category": "heading",
            "match": "heading",
            "condition": {
                f"level{heading['level']}": {
                    "font": heading["font"],
                    "size_pt": heading["size_pt"],
                    "bold": heading.get("bold", True),
                    "alignment": heading.get("alignment", "left")
                }
            }
        })

    return rules
```

---

## 7. 初始化数据

### 7.1 系统模板种子数据 (init_db.py)

```python
system_templates = [
    {
        "name": "GB/T 7714-2015 学术论文",
        "description": "中国国家标准学术论文格式规范",
        "is_default": True,
        "config": {...}
    },
    {
        "name": "本科毕业论文标准",
        "description": "普通本科毕业论文格式要求",
        "config": {...}
    },
    {
        "name": "硕士学位论文标准",
        "description": "硕士学位论文格式要求",
        "config": {...}
    },
    {
        "name": "期刊投稿格式",
        "description": "一般期刊投稿论文格式要求",
        "config": {...}
    }
]
```

---

## 8. 路由配置

### 8.1 前端路由

```javascript
// router/index.js
{
  path: '/rules',
  name: 'Rules',
  component: () => import('@/views/RulesView.vue'),
  meta: { requiresAuth: false }  // 未登录游客需先登录
},
{
  path: '/rules/new',
  name: 'NewRule',
  component: () => import('@/views/NewRuleView.vue'),
  meta: { requiresAuth: false }
}

// 路由守卫
router.beforeEach((to, from, next) => {
  const authStore = useAuthStore()

  // 未登录用户访问规则中心需要登录
  if (!authStore.isAuthenticated && to.path.startsWith('/rules')) {
    next('/login')
    return
  }
  next()
})
```

### 8.2 导航入口

```vue
<!-- NavBar.vue -->
<a @click="navigateTo('/rules')">规则中心</a>

<script>
const navigateTo = (path) => {
  // 游客点击规则中心时，引导登录
  if (path.startsWith('/rules') && authStore.isGuest) {
    router.push('/login')
    return
  }
  router.push(path)
}
</script>
```

---

## 9. 样式与布局

### 9.1 规则中心布局优化

```vue
<!-- 最大宽度限制，两边留白 -->
<div class="max-w-[1600px] mx-auto p-6">
  <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
    <!-- 左侧模板列表: 2/12 (17%) -->
    <div class="lg:col-span-2">...</div>

    <!-- 中间预览: 7/12 (58%) -->
    <div class="lg:col-span-7">...</div>

    <!-- 右侧参数: 3/12 (25%) -->
    <div class="lg:col-span-3">...</div>
  </div>
</div>
```

### 9.2 A4预览比例

```javascript
// A4尺寸: 21cm × 29.7cm
// 1cm ≈ 37.8px (96 DPI)
const a4Width = 794   // 21cm
const a4Height = 1123  // 29.7cm

// 页边距转换
const configMargins = computed(() => {
  const m = localConfig.value.page.margins
  return `${m.top_cm * 37.8}px ${m.right_cm * 37.8}px ${m.bottom_cm * 37.8}px ${m.left_cm * 37.8}px`
})
```

---

## 10. 权限控制

### 10.1 前端权限

```javascript
// 系统模板：只读开关禁用
<button
  :disabled="currentTemplate?.template_type === 'system'"
  class="... disabled:opacity-50 disabled:cursor-not-allowed"
>
  只读开关
</button>

// 系统模板：只显示"保存为副本"
<button v-if="currentTemplate?.template_type === 'system'" @click="saveAsCopy">
  保存为副本
</button>
<button v-else @click="updateTemplate">
  保存修改
</button>
```

### 10.2 后端权限

```python
@router.put("/{template_id}")
async def update_template(
    template_id: int,
    request: RuleTemplateUpdateRequest,
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    template = db.query(RuleTemplate).filter(RuleTemplate.id == template_id).first()

    # 系统模板不允许修改
    if template.template_type == TemplateType.SYSTEM:
        return ApiResponse(code=4003, message="系统模板不允许修改", data=None)

    # 自定义模板只能创建者修改
    if template.user_id != current_user.id:
        return ApiResponse(code=4004, message="无权限修改此模板", data=None)

    # 执行更新...
```

---

## 11. 关键技术点

### 11.1 JSON字段存储

```python
# 模型定义
from sqlalchemy.dialects.mysql import JSON

config_json = Column(JSON, nullable=False)

# 使用
template = RuleTemplate(
    name="我的模板",
    config_json={
        "page": {"margins": {...}},
        "headings": [...],
        "body": {...}
    }
)
```

### 11.2 LLM API调用

```python
client = AsyncOpenAI(
    api_key=settings.AI_API_KEY,
    base_url=settings.AI_BASE_URL
)

response = await client.chat.completions.create(
    model=settings.AI_MODEL,
    messages=[
        {"role": "system", "content": SYSTEM_PROMPT},
        {"role": "user", "content": f"请将以下格式要求解析为JSON：\n\n{text}"}
    ],
    temperature=0.3,
    max_tokens=1000
)

result_text = response.choices[0].message.content.strip()
config = json.loads(result_text)
```

### 11.3 Docx样式提取

```python
from docx import Document

doc = Document(file_path)

# 页边距
sections = doc.sections
section = sections[0]
margin_top_cm = section.top_margin.cm
margin_left_cm = section.left_margin.cm

# 段落样式
for para in doc.paragraphs:
    font_name = para.style.font.name
    font_size = para.style.font.size
    alignment = para.alignment
```

---

## 12. 数据流图

```
┌────────────────────────────────────────────────────────────┐
│                    创建规则流程                              │
└────────────────────────────────────────────────────────────┘

用户输入格式要求
    │
    ├─→ [路径A: 文字描述]
    │   └─→ POST /api/rule-templates/parse/text
    │       └─→ AI解析 → 返回JSON配置
    │
    └─→ [路径B: 上传范文]
        └─→ POST /api/rule-templates/parse/docx
            └─→ DocxParser → 提取样式 → 返回JSON配置
    │
    ↓
前端展示解析结果
    │
    ├─→ 中间栏：提取的配置项列表
    └─→ 右侧栏：A4预览效果
    │
    ↓
用户确认并保存
    │
    └─→ POST /api/rule-templates
        └─→ 保存到数据库
            │
            ↓
        返回规则中心
            │
            ↓
        [选择模板进行检测]
            │
            └─→ POST /api/check (携带rule_template_id)
                └─→ config_to_rules() → 生成检测规则
                    └─→ 执行检测 → 返回结果
```

---

## 13. 测试要点

### 13.1 功能测试

| 测试场景 | 验证点 |
|---------|-------|
| 查看系统模板 | 列表正确显示，默认模板标识 |
| 查看自定义模板 | 仅显示自己的模板 |
| 实时预览 | 修改参数，预览即时更新 |
| AI文本解析 | 输入格式要求，正确解析为配置 |
| Docx解析 | 上传范文，正确提取样式 |
| 保存副本 | 系统模板保存为自定义模板 |
| 修改模板 | 自定义模板可修改保存 |
| 删除模板 | 自定义模板可删除 |
| 检测集成 | 选择模板进行检测 |

### 13.2 边界测试

| 测试场景 | 预期结果 |
|---------|---------|
| 无AI配置时 | 使用正则解析后备方案 |
| AI解析失败 | 降级到规则解析 |
| 系统模板修改 | 提示"保存为副本" |
| 修改他人模板 | 权限拒绝 |
| 游客访问 | 重定向登录 |

---

## 14. 相关文档

- [API接口文档](./API接口文档.md)
- [数据库设计](./数据库设计（MVP版）.md)
- [规则引擎实现细节](./规则引擎实现细节.md)
- [MVP方案](./MVP方案.md)

---

## 15. 更新日志

| 日期 | 版本 | 更新内容 |
|------|------|---------|
| 2026-01-09 | v1.0 | 初始版本，完成规则中心核心功能 |
