# 游客模式功能实现文档

## 1. 功能概述

### 1.1 功能目标
允许未登录用户以游客身份试用文档格式检查功能，限制试用次数，引导用户注册登录。

### 1.2 核心特性
- **匿名试用**：无需注册即可体验文档检查
- **次数限制**：游客最多可进行 2 次基础检测
- **历史记录**：本地保存最多 2 条检查记录
- **数据迁移**：登录后自动迁移游客数据到正式账户
- **引导转化**：次数用完或查看详细报告时引导登录

### 1.3 业务流程
```
用户访问网站
    ↓
初始化游客会话（创建临时账户 + Token）
    ↓
上传文档检测
    ↓
显示检测结果（简化版）
    ↓
引导登录/注册 → 数据迁移 → 完整功能
```

---

## 2. 技术架构

### 2.1 技术选型

| 技术点 | 方案 | 说明 |
|--------|------|------|
| 游客标识 | JWT Token | 7天有效期，复用现有认证体系 |
| 数据存储 | localStorage + 数据库 | 临时数据本地存储，检测记录同步后端 |
| 状态管理 | Pinia Store | 集中管理游客状态和历史记录 |
| 路由控制 | Vue Router Guards | 拦截游客访问控制台等页面 |

### 2.2 文件结构

```
frontend/src/
├── constants/
│   └── guest.js              # 游客相关常量
├── stores/
│   ├── auth.js               # 认证状态（含游客判断）
│   └── guest.js              # 游客专用状态管理
├── components/
│   └── GuestHistoryList.vue  # 游客历史记录组件
├── views/
│   ├── HomeView.vue          # 首页（游客上传区）
│   ├── LoginView.vue         # 登录页（数据迁移）
│   └── DashboardView.vue     # 控制台（游客拦截）
└── utils/
    └── format.js             # 格式化工具函数

backend/app/
├── api/
│   ├── guest.py              # 游客 API 路由
│   └── auth.py               # 认证 API（含数据迁移）
└── models/
    └── user.py               # 用户模型（支持游客账户）
```

---

## 3. 数据库设计

### 3.1 游客账户

游客账户与正式账户使用相同的 `User` 表，通过用户名前缀区分：

```python
# 游客账户特征
username: "guest_{uuid}"      # 例如: guest_4375cffe2af2
nickname: "游客_{后6位}"       # 例如: 游客_e2af2
free_count: 0                 # 无免费额度
basic_count: 2                # 2次基础检测额度
full_count: 0                 # 无AI检测额度
```

### 3.2 数据迁移

登录时执行以下操作：
1. 根据 `guest_username` 查找游客账户
2. 将游客的所有 `Check` 记录的 `user_id` 更新为目标用户
3. 删除游客账户
4. 清理本地游客 Token

---

## 4. API 接口设计

### 4.1 初始化游客会话

**接口**: `POST /api/guest/init`

**请求**: 无需认证

**响应**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "access_token": "eyJhbGc...",    // JWT Token, 7天有效
    "token_type": "bearer",
    "expires_in": 604800,            // 7天 = 7 * 24 * 60 * 60
    "user": {
      "id": 123,
      "username": "guest_4375cffe2af2",
      "nickname": "游客_e2af2",
      "basic_count": 2,
      "free_count": 0,
      "full_count": 0
    }
  }
}
```

**实现要点**:
```python
@router.post("/init")
async def init_guest_session(db: Session = Depends(get_db)):
    # 生成唯一游客ID
    guest_id = f"guest_{uuid.uuid4().hex[:12]}"
    guest_username = f"游客_{guest_id[-6:]}"

    # 创建游客账户
    guest_user = User(
        username=guest_id,
        password_hash=get_password_hash("guest_temp"),
        nickname=guest_username,
        free_count=0,
        basic_count=2,
        full_count=0
    )
    db.add(guest_user)
    db.commit()
    db.refresh(guest_user)

    # 生成 Token（使用 user.id）
    access_token = create_access_token(
        data={"sub": str(guest_user.id)},
        expires_delta=timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)
    )

    return ApiResponse(
        code=200,
        message="success",
        data={
            "access_token": access_token,
            "token_type": "bearer",
            "expires_in": 604800,
            "user": {
                "id": guest_user.id,
                "username": guest_user.username,
                "nickname": guest_user.nickname,
                "basic_count": guest_user.basic_count,
                "free_count": guest_user.free_count,
                "full_count": guest_user.full_count
            }
        }
    )
```

### 4.2 登录（含数据迁移）

**接口**: `POST /api/auth/login`

**请求参数**:
```json
{
  "username": "test_user",
  "password": "password123",
  "guest_username": "guest_4375cffe2af2"  // 可选，游客用户名
}
```

**数据迁移逻辑**:
```python
def _migrate_guest_data(db: Session, guest_username: str, target_user_id: int):
    """迁移游客数据到正式账户"""
    # 查找游客账户
    guest_user = db.query(User).filter(User.username == guest_username).first()
    if not guest_user:
        return

    # 更新所有检测记录的 user_id
    updated_count = db.query(Check).filter(
        Check.user_id == guest_user.id
    ).update({"user_id": target_user_id}, synchronize_session=False)

    # 删除游客账户
    db.delete(guest_user)
    db.commit()
```

---

## 5. 前端实现

### 5.1 状态管理

#### Guest Store (`stores/guest.js`)

```javascript
export const useGuestStore = defineStore('guest', () => {
  // 状态
  const trialCount = ref(0)           // 已使用次数
  const history = ref([])             // 历史记录（最多2条）

  // 计算属性
  const remainingTrials = computed(() =>
    Math.max(0, MAX_TRIAL_COUNT - trialCount.value)
  )

  const hasTrialsRemaining = computed(() =>
    remainingTrials.value > 0
  )

  // Actions
  const incrementTrialCount = () => {
    trialCount.value++
    _saveToStorage()
  }

  const addToHistory = (checkRecord) => {
    if (history.value.length >= MAX_HISTORY_COUNT) {
      return { success: false, message: '游客最多可保存2条检查记录' }
    }
    history.value.unshift(checkRecord)
    _saveToStorage()
    return { success: true }
  }

  // localStorage 持久化
  const _saveToStorage = () => {
    localStorage.setItem(GUEST_STORAGE_KEY, JSON.stringify({
      trialCount: trialCount.value,
      history: history.value
    }))
  }

  return {
    trialCount,
    history,
    remainingTrials,
    hasTrialsRemaining,
    incrementTrialCount,
    addToHistory
  }
})
```

#### Auth Store (`stores/auth.js`)

```javascript
// 游客判断：基于 localStorage
const isGuest = computed(() => {
  return !!localStorage.getItem(GUEST_TOKEN_KEY) &&
         !localStorage.getItem('token')
})

// 初始化游客会话
const initGuestSession = async () => {
  const existingToken = localStorage.getItem(GUEST_TOKEN_KEY)
  if (existingToken) {
    // 验证现有 Token
    return { success: true, hasExisting: true }
  }

  // 创建新游客会话
  const response = await api.post('/api/guest/init')
  if (response.data.code === 200) {
    token.value = response.data.data.access_token
    user.value = response.data.data.user
    localStorage.setItem(GUEST_TOKEN_KEY, token.value)
    return { success: true, hasExisting: false }
  }
}
```

### 5.2 路由守卫

```javascript
// router/index.js
router.beforeEach((to, from, next) => {
  const hasGuestToken = !!localStorage.getItem('guest_token')
  const hasRegularToken = !!localStorage.getItem('token')
  const isGuest = hasGuestToken && !hasRegularToken

  // 游客访问控制台 -> 引导登录
  if (to.path === '/dashboard' && isGuest) {
    next('/login')
  } else {
    next()
  }
})
```

### 5.3 首页实现

#### 上传区域状态切换

```vue
<!-- 检测中状态 -->
<div v-if="checking">
  <progress-bar :progress="progress" />
</div>

<!-- 次数用完 - 引导登录 -->
<div v-else-if="authStore.isGuest && !guestStore.hasTrialsRemaining">
  <lock-icon />
  <h4>试用次数已用完</h4>
  <button @click="router.push('/login')">立即登录</button>
</div>

<!-- 上传区域 -->
<div v-else>
  <upload-area @upload="handleUpload" />
  <p v-if="authStore.isGuest">
    游客可试用 {{ guestStore.remainingTrials }} 次
  </p>
</div>
```

#### 检测流程

```javascript
const startCheck = async (file) => {
  if (!guestStore.hasTrialsRemaining) {
    showGuestModal.value = true
    return
  }

  checking.value = true

  // 1. 上传文件
  const uploadResponse = await checkApi.upload(file, 'basic')
  const fileId = uploadResponse.data.data.file_id

  // 2. 提交检测
  const checkResponse = await checkApi.submit(fileId, 'basic')
  const checkId = checkResponse.data.data.check_id

  // 3. 轮询结果
  await pollForResult(checkId, file.name)
}

const pollForResult = async (checkId, filename) => {
  const response = await checkApi.getResult(checkId)
  const data = response.data.data

  if (data.status === 'completed') {
    // 保存到游客历史
    guestStore.incrementTrialCount()
    guestStore.addToHistory({
      filename: filename,
      check_type: data.check_type,
      status: data.status,
      total_issues: data.result?.total_issues || 0,
      created_at: data.created_at,
      result: data.result
    })
    ElMessage.success('检查完成！')
  }
}
```

### 5.4 历史记录组件

```vue
<template>
  <div class="guest-history">
    <h3>最近检查记录</h3>
    <span class="badge">游客模式 (最多2条)</span>

    <div v-for="item in historyItems" :key="item.id">
      <file-info :filename="item.filename" :time="item.created_at" />
      <score-display :issues="item.total_issues" />
      <view-button @click="showLoginPrompt = true">查看</view>
    </div>

    <!-- 登录提示弹窗 -->
    <modal v-if="showLoginPrompt">
      <lock-icon />
      <h3>登录解锁完整报告</h3>
      <button @click="goToLogin">立即登录</button>
    </modal>
  </div>
</template>

<script setup>
const historyItems = computed(() => {
  return guestStore.history.slice(0, 2)
})
</script>
```

### 5.5 登录页面

```javascript
const login = async (username, password) => {
  // 获取当前游客用户名（用于数据迁移）
  const guestUsername = authStore.user?.username?.startsWith('guest_')
    ? authStore.user.username
    : null

  const response = await api.post('/api/auth/login', {
    username,
    password,
    guest_username: guestUsername  // 传递游客用户名
  })

  if (response.data.code === 200) {
    // 设置正式用户信息
    authStore.setUser(response.data.data.user, response.data.data.access_token)

    // 清理游客会话
    guestStore.clearSession()
    guestStore.clearGuestToken()
  }
}
```

---

## 6. 常量配置

### 6.1 游客相关常量

**文件**: `frontend/src/constants/guest.js`

```javascript
export const GUEST_STORAGE_KEY = 'guestSession'    // localStorage 会话key
export const GUEST_TOKEN_KEY = 'guest_token'      // Token key
export const MAX_TRIAL_COUNT = 2                  // 最大试用次数
export const MAX_HISTORY_COUNT = 2                // 最大历史记录数
```

### 6.2 后端配置

```python
# JWT 配置
ACCESS_TOKEN_EXPIRE_MINUTES = 10080  # 7天 = 7 * 24 * 60

# 游客配置
GUEST_BASIC_COUNT = 2     # 基础检测次数
GUEST_FULL_COUNT = 0      # AI检测次数
GUEST_FREE_COUNT = 0      # 免费次数
```

---

## 7. 关键技术点

### 7.1 Token 策略

游客使用与正式用户相同的 JWT Token 机制：

| 类型 | Token 存储 | Token 来源 | 有效期 |
|------|-----------|-----------|--------|
| 游客 | `guest_token` | `/api/guest/init` | 7天 |
| 正式用户 | `token` | `/api/auth/login` | 7天 |

**判断逻辑**:
```javascript
isGuest = 有 guest_token && 无 token
```

### 7.2 响应式更新

问题：游客历史记录添加后，组件不更新

解决方案：使用 `watch` 监听 store 变化

```javascript
// HomeView.vue
const showGuestHistory = ref(false)

watch(
  () => guestStore.history?.length || 0,
  (newLength) => {
    showGuestHistory.value = authStore.isGuest && newLength > 0
  },
  { immediate: true }
)
```

### 7.3 Pinia 自动解包

```javascript
// store 中定义
const history = ref([])

// 组件中访问
// ❌ 错误：guestStore.history.value（Pinia 已解包）
// ✅ 正确：guestStore.history（直接使用）
```

### 7.4 localStorage 同步

```javascript
// 保存时同步
const _saveToStorage = () => {
  localStorage.setItem(GUEST_STORAGE_KEY, JSON.stringify({
    trialCount: trialCount.value,
    history: history.value
  }))
}

// 初始化时恢复
const storedSession = JSON.parse(localStorage.getItem(GUEST_STORAGE_KEY) || 'null')
const trialCount = ref(storedSession?.trialCount || 0)
const history = ref(Array.isArray(storedSession?.history) ? storedSession.history : [])
```

---

## 8. 转化引导设计

### 8.1 触发场景

| 场景 | 触发条件 | 引导方式 |
|------|---------|---------|
| 次数用完 | `remainingTrials === 0` | 上传区显示登录引导卡片 |
| 查看报告 | 点击"查看"按钮 | 弹窗提示登录解锁完整报告 |
| 访问控制台 | 游客访问 `/dashboard` | 路由重定向到登录页 |

### 8.2 引导话术

```
【次数用完】
标题：试用次数已用完
描述：登录后可享受更多功能
- 永久保存检查记录
- 解锁历史记录管理
- 每月3次免费基础检测

【查看报告】
标题：登录解锁完整报告
描述：登录后可查看详细的格式问题列表，
      并永久保存您的检查记录
```

---

## 9. 数据流图

```
┌─────────────────────────────────────────────────────────────┐
│                        用户操作流程                           │
└─────────────────────────────────────────────────────────────┘

访问首页
    │
    ├─→ [检查 localStorage]
    │   ├─ 有 guest_token → 恢复游客会话
    │   └─ 无 token → 调用 /api/guest/init
    │
    ↓
上传文档检测
    │
    ├─→ [验证次数]
    │   ├─ 有剩余次数 → 继续检测
    │   └─ 无剩余次数 → 显示登录引导
    │
    ↓
提交检测
    │
    ├─→ [上传文件] /api/check/upload
    ├─→ [提交检测] /api/check/submit
    └─→ [轮询结果] /api/check/result
    │
    ↓
检测完成
    │
    ├─→ [更新状态]
    │   ├─ incrementTrialCount()     // 本地计数+1
    │   ├─ addToHistory(record)      // 保存到历史
    │   └─ _saveToStorage()          // 同步localStorage
    │
    ├─→ [显示结果]（简化版）
    │   └─ 分数 + 问题数
    │
    └─→ [引导转化]
        ├─ 查看详细 → 提示登录
        └─ 次数用完 → 提示登录
```

---

## 10. 测试要点

### 10.1 功能测试

| 测试场景 | 验证点 |
|---------|-------|
| 首次访问 | 自动创建游客会话 |
| 上传检测 | 次数正确扣减 |
| 历史记录 | 正确保存和显示 |
| 次数用完 | 显示登录引导 |
| 点击查看 | 弹出登录提示 |
| 游客登录 | 数据成功迁移 |
| 刷新页面 | 状态正确恢复 |

### 10.2 边界测试

| 测试场景 | 预期结果 |
|---------|---------|
| Token过期 | 重新初始化游客会话 |
| localStorage清空 | 重新初始化 |
| 网络错误 | 显示错误提示 |
| 并发检测 | 次数正确扣减 |

---

## 11. 性能优化

### 11.1 减少请求

- 游客历史记录优先从 localStorage 读取
- 仅在必要时调用后端 API

### 11.2 代码复用

- 提取共享常量到 `constants/guest.js`
- 提取工具函数到 `utils/format.js`
- 统一 `isGuest` 判断逻辑

### 11.3 状态管理

- 使用 computed 属性避免重复计算
- 使用 watch 监听状态变化

---

## 12. 安全考虑

### 12.1 游客账户

- 使用随机 UUID 生成唯一标识
- 密码使用占位符（无法登录）
- Token 有效期限制（7天）

### 12.2 数据隔离

- 游客数据与正式用户数据分离
- 迁移后立即删除游客账户
- 本地存储敏感数据加密

### 12.3 接口保护

- 所有检测接口需要 Token 认证
- 游客 Token 与正式 Token 同等验证
- 限制游客账户权限（无AI检测）

---

## 13. 后续优化方向

### 13.1 功能增强

- [ ] 支持游客查看更多历史记录（需登录）
- [ ] 添加游客数据统计页面
- [ ] 支持游客分享检测结果

### 13.2 数据分析

- [ ] 游客转化率统计
- [ ] 游客行为路径分析
- [ ] A/B 测试不同引导话术

### 13.3 技术优化

- [ ] 使用 Web Worker 处理大文件
- [ ] 添加离线缓存支持
- [ ] 优化 Token 刷新机制

---

## 14. 相关文档

- [API 接口文档](./API接口文档.md)
- [数据库设计](./数据库设计（MVP版）.md)
- [MVP 方案](./MVP方案.md)

---

## 15. 更新日志

| 日期 | 版本 | 更新内容 |
|------|------|---------|
| 2026-01-06 | v1.0 | 初始版本，完成游客模式核心功能 |
