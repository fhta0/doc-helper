# 文档解析技术方案

## 技术选型

### 解析库
- **python-docx**: Python库，用于读取和写入Microsoft Word (.docx)文件
- **版本要求**: python-docx >= 0.8.11
- **安装**: `pip install python-docx`

### 支持的格式
- ✅ `.docx` (Microsoft Word 2007+)
- ❌ `.doc` (旧版Word格式，不支持)
- ❌ `.wps` (WPS格式，暂不支持，后续版本可考虑)

---

## 文档结构提取

### 提取的数据结构

#### 1. 文档基本信息
```python
{
    "filename": "论文.docx",
    "file_size": 1024000,
    "page_count": 10,  # 需要计算或估算
    "word_count": 5000  # 可选，单词/字符数统计
}
```

#### 2. 页面设置 (Page Settings)
```python
{
    "paper_size": {
        "width_mm": 210,  # 宽度（毫米）
        "height_mm": 297  # 高度（毫米）
    },
    "margins": {
        "top_mm": 25.4,     # 上边距（毫米）
        "bottom_mm": 25.4,  # 下边距（毫米）
        "left_mm": 25.4,    # 左边距（毫米）
        "right_mm": 25.4    # 右边距（毫米）
    },
    "orientation": "portrait"  # portrait（纵向）或 landscape（横向）
}
```

#### 3. 段落 (Paragraphs)
```python
{
    "paragraphs": [
        {
            "index": 0,  # 段落索引
            "text": "这是段落文本",
            "style": {
                "name": "Normal",  # 样式名称
                "font_name": "宋体",
                "font_size_pt": 12,
                "bold": False,
                "italic": False,
                "alignment": "left"  # left, center, right, justify
            },
            "formatting": {
                "first_line_indent_mm": 10.6,  # 首行缩进（毫米，1字符≈5.3mm）
                "first_line_indent_chars": 2,  # 首行缩进（字符数，估算）
                "line_spacing": 1.5,  # 行距（倍数或固定值）
                "space_before_pt": 0,  # 段前间距（磅）
                "space_after_pt": 0    # 段后间距（磅）
            }
        }
    ]
}
```

#### 4. 字体信息 (Run/Font)
```python
{
    "runs": [  # 段落内的文本运行（可能有不同的字体格式）
        {
            "paragraph_index": 0,
            "run_index": 0,
            "text": "中文文本",
            "font": {
                "name": "宋体",
                "size_pt": 12,
                "bold": False,
                "italic": False,
                "underline": False
            }
        },
        {
            "paragraph_index": 0,
            "run_index": 1,
            "text": "English Text",
            "font": {
                "name": "Times New Roman",
                "size_pt": 10.5,
                "bold": False,
                "italic": False
            }
        }
    ]
}
```

#### 5. 标题 (Headings)
```python
{
    "headings": [
        {
            "level": 1,  # 标题级别（1-9）
            "text": "第一章 绪论",
            "style_name": "Heading 1",
            "font": {
                "name": "黑体",
                "size_pt": 16,
                "bold": True
            },
            "alignment": "center",
            "paragraph_index": 2
        }
    ]
}
```

#### 6. 表格 (Tables)
```python
{
    "tables": [
        {
            "index": 0,
            "rows": 3,
            "cols": 4,
            "caption": "表1-1 示例表格",  # 表格标题（需要从上下文提取）
            "caption_position": "above"  # above（上方）或 below（下方）
        }
    ]
}
```

#### 7. 图片 (Images/Figures)
```python
{
    "figures": [
        {
            "index": 0,
            "width_mm": 100,
            "height_mm": 80,
            "caption": "图1-1 示例图片",  # 图片标题（需要从上下文提取）
            "caption_position": "below",  # above（上方）或 below（下方）
            "paragraph_index": 10
        }
    ]
}
```

#### 8. 完整文档结构（汇总）
```python
{
    "document": {
        "info": {...},  # 文档基本信息
        "page_settings": {...},  # 页面设置
        "paragraphs": [...],  # 段落列表
        "runs": [...],  # 文本运行列表
        "headings": [...],  # 标题列表
        "tables": [...],  # 表格列表
        "figures": [...]  # 图片列表
    }
}
```

---

## 实现代码示例

### 基础解析器类结构

```python
from docx import Document
from docx.shared import Pt, Mm, Inches
from docx.enum.text import WD_ALIGN_PARAGRAPH

class DocxParser:
    """DOCX文档解析器"""
    
    def __init__(self, file_path: str):
        self.file_path = file_path
        self.doc = Document(file_path)
        self.structure = {}
    
    def parse(self) -> dict:
        """解析文档，返回结构化数据"""
        return {
            "info": self._parse_info(),
            "page_settings": self._parse_page_settings(),
            "paragraphs": self._parse_paragraphs(),
            "runs": self._parse_runs(),
            "headings": self._parse_headings(),
            "tables": self._parse_tables(),
            "figures": self._parse_figures()
        }
    
    def _parse_info(self) -> dict:
        """解析文档基本信息"""
        # 实现细节...
        pass
    
    def _parse_page_settings(self) -> dict:
        """解析页面设置"""
        sections = self.doc.sections
        if sections:
            section = sections[0]
            page_width = section.page_width
            page_height = section.page_height
            
            return {
                "paper_size": {
                    "width_mm": self._convert_to_mm(page_width),
                    "height_mm": self._convert_to_mm(page_height)
                },
                "margins": {
                    "top_mm": self._convert_to_mm(section.top_margin),
                    "bottom_mm": self._convert_to_mm(section.bottom_margin),
                    "left_mm": self._convert_to_mm(section.left_margin),
                    "right_mm": self._convert_to_mm(section.right_margin)
                },
                "orientation": "portrait"  # 需要根据宽高判断
            }
        return {}
    
    def _parse_paragraphs(self) -> list:
        """解析段落"""
        paragraphs = []
        for idx, para in enumerate(self.doc.paragraphs):
            # 解析段落样式和格式
            para_data = {
                "index": idx,
                "text": para.text,
                "style": self._parse_paragraph_style(para),
                "formatting": self._parse_paragraph_formatting(para)
            }
            paragraphs.append(para_data)
        return paragraphs
    
    def _parse_runs(self) -> list:
        """解析文本运行（字体信息）"""
        runs = []
        for para_idx, para in enumerate(self.doc.paragraphs):
            for run_idx, run in enumerate(para.runs):
                run_data = {
                    "paragraph_index": para_idx,
                    "run_index": run_idx,
                    "text": run.text,
                    "font": self._parse_font(run.font)
                }
                runs.append(run_data)
        return runs
    
    def _parse_headings(self) -> list:
        """解析标题"""
        headings = []
        for para_idx, para in enumerate(self.doc.paragraphs):
            if para.style.name.startswith('Heading'):
                level = int(para.style.name.split()[-1]) if para.style.name.split()[-1].isdigit() else 1
                headings.append({
                    "level": level,
                    "text": para.text,
                    "style_name": para.style.name,
                    "font": self._parse_font_from_style(para.style),
                    "alignment": self._get_alignment(para.alignment),
                    "paragraph_index": para_idx
                })
        return headings
    
    def _parse_tables(self) -> list:
        """解析表格"""
        tables = []
        for idx, table in enumerate(self.doc.tables):
            tables.append({
                "index": idx,
                "rows": len(table.rows),
                "cols": len(table.columns),
                "caption": self._extract_table_caption(idx),  # 需要从上下文提取
                "caption_position": "above"  # 需要判断
            })
        return tables
    
    def _parse_figures(self) -> list:
        """解析图片"""
        figures = []
        # python-docx 对图片的支持有限，可能需要使用其他方法
        # 可以通过段落中的内联图片来提取
        for para_idx, para in enumerate(self.doc.paragraphs):
            if para._element.xpath('.//a:blip'):
                # 包含图片的段落
                figures.append({
                    "index": len(figures),
                    "caption": self._extract_figure_caption(para_idx),
                    "caption_position": "below",
                    "paragraph_index": para_idx
                })
        return figures
    
    def _convert_to_mm(self, emu_value) -> float:
        """将EMU单位转换为毫米"""
        # 1 inch = 914400 EMU = 25.4 mm
        return (emu_value / 914400) * 25.4
    
    def _parse_font(self, font) -> dict:
        """解析字体信息"""
        return {
            "name": font.name if font.name else None,
            "size_pt": font.size.pt if font.size else None,
            "bold": font.bold if font.bold is not None else False,
            "italic": font.italic if font.italic is not None else False,
            "underline": font.underline is not None
        }
    
    # ... 其他辅助方法
```

---

## 单位转换

### 常用单位转换

| 单位 | 转换关系 |
|------|---------|
| EMU (English Metric Units) | 1 inch = 914400 EMU |
| 毫米 (mm) | 1 inch = 25.4 mm |
| 磅 (pt) | 1 inch = 72 pt |
| 字符 | 1 字符（中文字符）≈ 5.3 mm (12pt字体) |

### 转换函数
```python
def emu_to_mm(emu: int) -> float:
    """EMU转毫米"""
    return (emu / 914400) * 25.4

def pt_to_mm(pt: float) -> float:
    """磅转毫米"""
    return pt * 0.352778

def mm_to_chars(mm: float, font_size_pt: int = 12) -> float:
    """毫米转字符数（估算）"""
    # 中文字符宽度 ≈ font_size_pt * 1.2 pt
    char_width_mm = (font_size_pt * 1.2) * 0.352778
    return mm / char_width_mm
```

---

## 注意事项和限制

### python-docx的限制

1. **页面数量**: python-docx不直接提供页面数量，需要估算或使用其他方法
2. **图片提取**: 图片内容提取有限，主要可以获取位置和大小
3. **复杂格式**: 某些复杂格式（如文本框、艺术字）可能无法完美提取
4. **页眉页脚**: 页眉页脚需要单独处理（`doc.sections[0].header/footer`）
5. **样式继承**: 样式可能继承自Normal样式，需要处理继承关系

### 处理建议

1. **字体识别**: 中英文字体混合时，需要在run级别识别
2. **段落识别**: 空段落需要保留（可能用于格式布局）
3. **标题识别**: 除了样式名，也可以通过字体大小和格式判断标题
4. **图表标题提取**: 图表标题通常在其上方或下方的段落中，需要上下文分析
5. **首行缩进计算**: 首行缩进的字符数需要根据字体大小估算

---

## 错误处理

### 常见错误及处理

1. **文件损坏**: 捕获异常，返回错误信息
2. **文件格式错误**: 验证文件扩展名和内容
3. **编码问题**: 确保使用UTF-8编码
4. **内存问题**: 大文件可能导致内存问题，考虑流式处理

```python
def parse_document_safe(file_path: str) -> dict:
    """安全地解析文档，带错误处理"""
    try:
        parser = DocxParser(file_path)
        return {"success": True, "data": parser.parse()}
    except Exception as e:
        return {
            "success": False,
            "error": str(e),
            "error_type": type(e).__name__
        }
```

---

## 性能考虑

1. **大文件处理**: 对于大文件，考虑只解析需要检查的部分
2. **缓存机制**: 解析结果可以缓存，避免重复解析
3. **并行处理**: 不同部分的解析可以并行（如果性能需要）

---

## 测试数据

建议准备以下测试文档：
1. 标准格式的论文（符合规范的）
2. 包含各种格式问题的论文
3. 大文件（接近10MB限制）
4. 复杂格式的文档（多表格、多图片）

